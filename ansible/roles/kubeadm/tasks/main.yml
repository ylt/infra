---
# Mutual exclusivity - ensure Nomad is not present on Kubernetes nodes
- name: Stop Nomad service if running
  systemd:
    name: nomad
    state: stopped
    enabled: no
  when: kube_node | bool
  ignore_errors: yes

- name: Remove Docker on Kubernetes nodes
  apt:
    name:
      - docker.io
      - docker-ce
      - docker-ce-cli
      - docker-compose-plugin
    state: absent
  when: kube_node | bool
  ignore_errors: yes

# Prerequisites and system configuration
- name: Disable swap
  shell: swapoff -a
  when: ansible_swaptotal_mb > 0

- name: Remove swap from fstab
  lineinfile:
    path: /etc/fstab
    regexp: '.*swap.*'
    state: absent

- name: Load required kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter

- name: Make kernel modules persistent
  copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter

- name: Configure sysctl for Kubernetes
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { key: 'net.ipv4.ip_forward', value: '1' }

# Install containerd
- name: Install containerd and dependencies
  apt:
    name:
      - containerd
      - apt-transport-https
      - ca-certificates
      - curl
      - gpg
      - conntrack
      - socat
      - ebtables
    state: present
    update_cache: yes

- name: Create containerd config directory
  file:
    path: /etc/containerd
    state: directory
    mode: '0755'

- name: Generate default containerd config
  shell: containerd config default > /etc/containerd/config.toml
  args:
    creates: /etc/containerd/config.toml

- name: Configure containerd to use systemd cgroup driver
  lineinfile:
    path: /etc/containerd/config.toml
    regexp: '^\s+SystemdCgroup = false'
    line: '            SystemdCgroup = true'
    state: present

- name: Restart and enable containerd
  systemd:
    name: containerd
    state: restarted
    enabled: yes
    daemon_reload: yes

# Install Kubernetes packages
- name: Create keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Add Kubernetes apt key
  shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Add Kubernetes apt repository
  apt_repository:
    repo: 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /'
    filename: kubernetes
    state: present

- name: Install kubeadm, kubelet, and kubectl
  apt:
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: present
    update_cache: yes

- name: Hold Kubernetes packages at current version
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop:
    - kubelet
    - kubeadm
    - kubectl

# Master node initialization
- name: Check if cluster is already initialized
  stat:
    path: /etc/kubernetes/admin.conf
  register: k8s_initialized
  when: (is_master | default(false)) | bool

- name: Initialize Kubernetes cluster with kubeadm
  shell: |
    kubeadm init \
      --pod-network-cidr={{ k3s_cluster_cidr }} \
      --service-cidr={{ k3s_service_cidr }} \
      --apiserver-advertise-address={{ ansible_host }} \
      --skip-phases=addon/kube-proxy
  when: (is_master | default(false)) | bool and not k8s_initialized.stat.exists
  register: kubeadm_init

- name: Create .kube directory for root
  file:
    path: /root/.kube
    state: directory
    owner: root
    mode: '0755'
  when: (is_master | default(false)) | bool

- name: Copy kubeconfig for root
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    owner: root
    mode: '0600'
    remote_src: yes
  when: (is_master | default(false)) | bool

- name: Get kubeadm join command
  shell: kubeadm token create --print-join-command
  register: join_command_raw
  when: (is_master | default(false)) | bool

- name: Set join command as fact
  set_fact:
    join_command: "{{ join_command_raw.stdout }}"
  when: (is_master | default(false)) | bool

- name: Share join command with worker nodes
  set_fact:
    k8s_join_command: "{{ hostvars['node-5']['join_command'] }}"
  when: (is_worker | default(false)) | bool and not (is_master | default(false)) | bool

# Worker node join
- name: Check if node already joined cluster
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf
  when: (is_worker | default(false)) | bool and not (is_master | default(false)) | bool

- name: Join worker nodes to cluster
  shell: "{{ k8s_join_command }}"
  when: (is_worker | default(false)) | bool and not (is_master | default(false)) | bool and not kubelet_conf.stat.exists
