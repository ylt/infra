---
# Spegel containerd configuration for p2p image distribution

- name: Check if k0s is installed
  stat:
    path: /etc/k0s
  register: k0s_installed

- name: Create containerd.d directory
  file:
    path: /etc/k0s/containerd.d
    state: directory
    mode: '0755'
  when: k0s_installed.stat.exists

- name: Deploy Spegel containerd config
  copy:
    dest: /etc/k0s/containerd.d/spegel.toml
    content: |
      [plugins."io.containerd.grpc.v1.cri".registry]
        config_path = "/etc/containerd/certs.d"
      [plugins."io.containerd.grpc.v1.cri".containerd]
        discard_unpacked_layers = false
    mode: '0644'
  when: k0s_installed.stat.exists
  register: containerd_config

- name: Determine k0s service name
  set_fact:
    k0s_service: "{{ 'k0scontroller' if k0s_role == 'controller+worker' else 'k0sworker' }}"
  when: k0s_installed.stat.exists and containerd_config.changed

- name: Restart k0s service for Spegel config
  systemd:
    name: "{{ k0s_service }}"
    state: restarted
  when: k0s_installed.stat.exists and containerd_config.changed
