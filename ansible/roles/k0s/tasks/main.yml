---
# Mutual exclusivity - ensure Nomad is not present on k0s nodes
- name: Stop Nomad service if running
  systemd:
    name: nomad
    state: stopped
    enabled: no
  when: kube_node | bool
  ignore_errors: yes

- name: Remove Docker on Kubernetes nodes
  apt:
    name:
      - docker.io
      - docker-ce
      - docker-ce-cli
      - docker-compose-plugin
    state: absent
  when: kube_node | bool
  ignore_errors: yes

# Clean up existing kubeadm installation
- name: Stop kubelet if running
  systemd:
    name: kubelet
    state: stopped
    enabled: no
  when: kube_node | bool
  ignore_errors: yes

- name: Unhold Kubernetes packages
  dpkg_selections:
    name: "{{ item }}"
    selection: install
  loop:
    - kubelet
    - kubeadm
    - kubectl
  when: kube_node | bool
  ignore_errors: yes

- name: Remove kubeadm packages
  apt:
    name:
      - kubeadm
      - kubelet
      - kubectl
      - containerd
    state: absent
    purge: yes
  when: kube_node | bool
  ignore_errors: yes

- name: Remove Kubernetes directories
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/kubernetes
    - /var/lib/kubelet
    - /var/lib/etcd
    - /etc/cni
    - /opt/cni
    - /var/lib/cni
  when: kube_node | bool
  ignore_errors: yes

# Compatibility symlink for CSI drivers that hardcode /var/lib/kubelet
- name: Create kubelet symlink for k0s compatibility
  file:
    src: /var/lib/k0s/kubelet
    dest: /var/lib/kubelet
    state: link
    force: yes
  when: kube_node | bool

# System prerequisites
- name: Disable swap
  shell: swapoff -a
  when: ansible_swaptotal_mb > 0

- name: Remove swap from fstab
  lineinfile:
    path: /etc/fstab
    regexp: '.*swap.*'
    state: absent

- name: Load required kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter

- name: Make kernel modules persistent
  copy:
    dest: /etc/modules-load.d/k0s.conf
    content: |
      overlay
      br_netfilter

- name: Configure sysctl for Kubernetes
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { key: 'net.ipv4.ip_forward', value: '1' }

# Install k0s
- name: Download k0s binary
  get_url:
    url: https://github.com/k0sproject/k0s/releases/download/v1.31.2+k0s.0/k0s-v1.31.2+k0s.0-arm64
    dest: /usr/local/bin/k0s
    mode: '0755'
    owner: root
    group: root
  when: kube_node | bool

# Controller node setup
- name: Check if k0s is already installed on controller
  stat:
    path: /etc/systemd/system/k0scontroller.service
  register: k0s_controller_installed
  when: (is_master | default(false)) | bool

- name: Install k0s controller
  shell: k0s install controller --enable-worker
  when: (is_master | default(false)) | bool and not k0s_controller_installed.stat.exists

- name: Start k0s controller
  systemd:
    name: k0scontroller
    state: started
    enabled: yes
    daemon_reload: yes
  when: (is_master | default(false)) | bool

- name: Wait for k0s to be ready
  shell: k0s kubectl get nodes
  register: k0s_ready
  until: k0s_ready.rc == 0
  retries: 30
  delay: 10
  when: (is_master | default(false)) | bool
  changed_when: false

- name: Get k0s join token for workers
  shell: k0s token create --role=worker
  register: k0s_token
  when: (is_master | default(false)) | bool

- name: Set k0s token as fact
  set_fact:
    k0s_join_token: "{{ k0s_token.stdout }}"
  when: (is_master | default(false)) | bool

- name: Create kubeconfig directory
  file:
    path: /root/.kube
    state: directory
    owner: root
    mode: '0755'
  when: (is_master | default(false)) | bool

- name: Copy k0s kubeconfig
  shell: k0s kubeconfig admin > /root/.kube/config
  args:
    creates: /root/.kube/config
  when: (is_master | default(false)) | bool

# Worker node setup
- name: Get join token from controller
  set_fact:
    worker_join_token: "{{ hostvars['node-5']['k0s_join_token'] }}"
  when: (is_worker | default(false)) | bool and not (is_master | default(false)) | bool

- name: Check if k0s worker is already installed
  stat:
    path: /etc/systemd/system/k0sworker.service
  register: k0s_worker_installed
  when: (is_worker | default(false)) | bool and not (is_master | default(false)) | bool

- name: Write k0s worker token to file
  copy:
    content: "{{ worker_join_token }}"
    dest: /tmp/k0s-token
    mode: '0600'
  when: (is_worker | default(false)) | bool and not (is_master | default(false)) | bool and not k0s_worker_installed.stat.exists

- name: Install k0s worker
  shell: "k0s install worker --token-file /tmp/k0s-token"
  when: (is_worker | default(false)) | bool and not (is_master | default(false)) | bool and not k0s_worker_installed.stat.exists

- name: Start k0s worker
  systemd:
    name: k0sworker
    state: started
    enabled: yes
    daemon_reload: yes
  when: (is_worker | default(false)) | bool and not (is_master | default(false)) | bool
