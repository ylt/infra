---
# Stop Nomad on nodes that are no longer Nomad nodes
- name: Stop and disable Nomad service
  systemd:
    name: nomad
    state: stopped
    enabled: no
  when: not (nomad_node | bool)
  ignore_errors: yes

# Mutual exclusivity - ensure Kubernetes is not present on Nomad nodes
- name: Stop kubelet service if running
  systemd:
    name: kubelet
    state: stopped
    enabled: no
  when: nomad_node | bool
  ignore_errors: yes

- name: Unhold Kubernetes packages before removal
  dpkg_selections:
    name: "{{ item }}"
    selection: install
  loop:
    - kubelet
    - kubeadm
    - kubectl
  when: nomad_node | bool
  ignore_errors: yes

- name: Remove Kubernetes packages on Nomad nodes
  apt:
    name:
      - kubeadm
      - kubelet
      - kubectl
      - containerd
    state: absent
  when: nomad_node | bool
  ignore_errors: yes

- name: Ensure Docker 27.1.1 is installed on Nomad nodes
  shell: |
    if ! command -v docker &> /dev/null || ! docker --version | grep -q "27.1.1"; then
      curl -fsSL https://get.docker.com | sh -s -- --version 27.1.1
    fi
  when: nomad_node | bool
  args:
    executable: /bin/bash

- include_tasks: 1_cni.yml
  when: nomad_node | bool
- include_tasks: 2_dependencies.yml
  when: nomad_node | bool
- include_tasks: 3_uninstall-hashi-up.yml
  when: nomad_node | bool
- include_tasks: 4_install.yml
  when: nomad_node | bool
- include_tasks: 5_configuration.yml
  when: nomad_node | bool