---
- hosts: ubuntu-node-1
  become: true
  vars:
    consul_dns_port: 8600
    upstream_dns_servers:
      - 192.168.6.1

  tasks:
    - name: Install dnsmasq
      ansible.builtin.apt:
        name: dnsmasq
        state: present
        update_cache: yes

    - name: Disable systemd-resolved DNS stub listener (conflicts with dnsmasq)
      ansible.builtin.lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: '^#?DNSStubListener='
        line: 'DNSStubListener=no'
        state: present
      notify:
        - restart systemd-resolved

    - name: Create dnsmasq consul config
      ansible.builtin.copy:
        dest: /etc/dnsmasq.d/10-consul
        content: |
          # Forward .consul queries to Consul DNS on port 8600
          server=/consul/127.0.0.1#{{ consul_dns_port }}

          # Listen on all interfaces
          listen-address=0.0.0.0

          # Bind to interfaces (prevents conflicts)
          bind-interfaces

          # Don't read /etc/resolv.conf for upstream servers
          no-resolv

          # Use these upstream DNS servers for non-.consul queries
          {% for dns_server in upstream_dns_servers %}
          server={{ dns_server }}
          {% endfor %}

          # Cache settings
          cache-size=1000

          # Don't forward plain names (without dots)
          domain-needed

          # Don't forward addresses in the non-routed address spaces
          bogus-priv
        mode: '0644'
      notify:
        - restart dnsmasq

    - name: Ensure dnsmasq is enabled and started
      ansible.builtin.systemd:
        name: dnsmasq
        enabled: yes
        state: started

  handlers:
    - name: restart systemd-resolved
      ansible.builtin.systemd:
        name: systemd-resolved
        state: restarted

    - name: restart dnsmasq
      ansible.builtin.systemd:
        name: dnsmasq
        state: restarted
