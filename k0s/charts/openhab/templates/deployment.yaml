apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
  labels:
    app: {{ .Release.Name }}
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values:
                      - node-5
                      - node-6
      initContainers:
        - name: init-volumes
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          command:
            - sh
            - -c
            - |
              # Initialize conf if empty (ignore lost+found)
              if [ -z "$(ls -A /openhab/conf 2>/dev/null | grep -v lost+found)" ]; then
                echo "Initializing /openhab/conf..."
                cp -a /openhab/dist/conf/. /openhab/conf/
              fi
              # Initialize userdata if empty
              if [ -z "$(ls -A /openhab/userdata 2>/dev/null | grep -v lost+found | grep -v tmp)" ]; then
                echo "Initializing /openhab/userdata..."
                cp -a /openhab/dist/userdata/. /openhab/userdata/
              fi
              # Fix permissions
              chown -R 9001:9001 /openhab/conf /openhab/userdata /openhab/addons
          volumeMounts:
            - name: openhab-conf
              mountPath: /openhab/conf
            - name: openhab-userdata
              mountPath: /openhab/userdata
            - name: openhab-addons
              mountPath: /openhab/addons
      containers:
        - name: openhab
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.port }}
          env:
            - name: TZ
              value: "Europe/London"
            - name: OPENHAB_HTTP_PORT
              value: "{{ .Values.port }}"
            - name: EXTRA_JAVA_OPTS
              value: "-Duser.timezone=Europe/London"
          volumeMounts:
            - name: openhab-conf
              mountPath: /openhab/conf
            - name: openhab-userdata
              mountPath: /openhab/userdata
            - name: openhab-addons
              mountPath: /openhab/addons
            - name: localtime
              mountPath: /etc/localtime
              readOnly: true
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
      volumes:
        - name: openhab-conf
          {{- if .Values.persistence.enabled }}
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-conf
          {{- else }}
          emptyDir: {}
          {{- end }}
        - name: openhab-userdata
          {{- if .Values.persistence.enabled }}
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-userdata
          {{- else }}
          emptyDir: {}
          {{- end }}
        - name: openhab-addons
          {{- if .Values.persistence.enabled }}
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-addons
          {{- else }}
          emptyDir: {}
          {{- end }}
        - name: localtime
          hostPath:
            path: /etc/localtime
