# Vault configuration for k8s

server:
  # Single instance for homelab
  ha:
    enabled: false

  # Standalone mode with Raft storage
  standalone:
    enabled: true
    config: |
      ui = true

      listener "tcp" {
        tls_disable = 1
        address = "[::]:8200"
        cluster_address = "[::]:8201"
      }

      storage "raft" {
        path = "/vault/data"
      }

  # Persistent storage via Longhorn
  dataStorage:
    enabled: true
    size: 10Gi
    storageClass: longhorn

  # Expose via LoadBalancer
  service:
    type: LoadBalancer

  # Auto-unseal using K8s secret
  extraSecretEnvironmentVars:
    - envName: VAULT_UNSEAL_KEY
      secretName: vault-unseal-key
      secretKey: key

  postStart:
    - /bin/sh
    - -c
    - |
      sleep 5
      until vault status 2>&1 | grep -q "Sealed.*true"; do sleep 1; done
      vault operator unseal "$VAULT_UNSEAL_KEY" || true

# Enable the UI
ui:
  enabled: true
  serviceType: LoadBalancer
