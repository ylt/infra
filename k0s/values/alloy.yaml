# Alloy configuration for syslog ingestion

alloy:
  configMap:
    content: |
      // Syslog receiver for UniFi (BSD/RFC3164 format)
      loki.source.syslog "network" {
        listener {
          address = "0.0.0.0:1514"
          protocol = "udp"
          syslog_format = "rfc3164"
          labels = {
            job = "syslog",
          }
        }
        relabel_rules = loki.relabel.syslog_source.rules
        forward_to = [loki.process.unifi.receiver]
      }

      // Add source IP as label
      loki.relabel "syslog_source" {
        forward_to = []

        rule {
          source_labels = ["__syslog_connection_ip_address"]
          target_label  = "source_ip"
        }
        rule {
          source_labels = ["__syslog_connection_hostname"]
          target_label  = "source_host"
        }
      }

      // Parse UniFi firewall logs
      loki.process "unifi" {
        forward_to = [loki.write.default.receiver]

        // Extract rule name from brackets [RULE_NAME]
        stage.regex {
          expression = "\\[(?P<rule>[^\\]]+)\\]"
        }

        // Extract key=value pairs
        stage.regex {
          expression = "IN=(?P<iface_in>\\S*)"
        }
        stage.regex {
          expression = "OUT=(?P<iface_out>\\S*)"
        }
        stage.regex {
          expression = "SRC=(?P<src>\\S+)"
        }
        stage.regex {
          expression = "DST=(?P<dst>\\S+)"
        }
        stage.regex {
          expression = "PROTO=(?P<proto>\\S+)"
        }
        stage.regex {
          expression = "SPT=(?P<src_port>\\d+)"
        }
        stage.regex {
          expression = "DPT=(?P<dst_port>\\d+)"
        }

        // Add extracted values as labels
        stage.labels {
          values = {
            rule = "",
            proto = "",
            src = "",
            dst = "",
            src_port = "",
            dst_port = "",
            iface_in = "",
          }
        }
      }

      // Write to Loki
      loki.write "default" {
        endpoint {
          url = "http://loki.loki.svc.cluster.local:3100/loki/api/v1/push"
        }
      }

  # Extra ports on the container
  extraPorts:
    - name: syslog
      port: 1514
      targetPort: 1514
      protocol: UDP

controller:
  type: deployment
  replicas: 1

resources:
  requests:
    cpu: 50m
    memory: 128Mi
  limits:
    cpu: 200m
    memory: 256Mi

